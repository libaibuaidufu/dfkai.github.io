<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.0.0">
<meta name="google-site-verification" content="CE-yO4gFOATepoi_qIQqeqTBwQ5vzS9_rXjRw6YXwgI" />
<meta name="baidu-site-verification" content="gmVE4kf3bb" />
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  
  <link rel="stylesheet" href="/lib/animate-css/animate.min.css">
<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"libaibuaidufu.club","root":"/","scheme":"Gemini","version":"8.0.0-rc.5","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":{"disqus":{"order":-1},"valine":{"order":-2}}},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"path":"search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}};
  </script>

  <meta name="description" content="本来想着写第二篇的，但是一直没有什么头绪，就把以前自己看过的文章转载一下，同时在温故而知新。然后在根据理解在进行写。我要转载也是因为别人写的好很详细。 同时还有更详细的 就是此作者在后面的参考中的。当然我也是看过的，别人写的更加详细。以模块分类进行深度讲解。 看了下面两篇可以让你对Flask有着更深的认识。 后续我也会写一些自己的认识。">
<meta property="og:type" content="article">
<meta property="og:title" content="转载-flask源码分析">
<meta property="og:url" content="https://libaibuaidufu.club/post/%E8%BD%AC%E8%BD%BD-flask%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.html">
<meta property="og:site_name" content="libaibuaidufu">
<meta property="og:description" content="本来想着写第二篇的，但是一直没有什么头绪，就把以前自己看过的文章转载一下，同时在温故而知新。然后在根据理解在进行写。我要转载也是因为别人写的好很详细。 同时还有更详细的 就是此作者在后面的参考中的。当然我也是看过的，别人写的更加详细。以模块分类进行深度讲解。 看了下面两篇可以让你对Flask有着更深的认识。 后续我也会写一些自己的认识。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-08-13T08:03:23.000Z">
<meta property="article:modified_time" content="2020-08-13T08:03:55.406Z">
<meta property="article:author" content="libaibuaidufu">
<meta property="article:tag" content="flask">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://libaibuaidufu.club/post/%E8%BD%AC%E8%BD%BD-flask%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.html">


<script data-pjax class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>转载-flask源码分析 | libaibuaidufu</title>
  


  <script data-pjax>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?3d5d85723eac2f793adb6994a09f5b25";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <main class="main">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader">
        <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">libaibuaidufu</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">小黄说他不是狗。。。</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">16</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">8</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">15</span></a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>站点地图</a>

  </li>
        <li class="menu-item menu-item-comments">

    <a href="/comments/" rel="section"><i class="fa fa-comments fa-fw"></i>留言板</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <section class="post-toc-wrap sidebar-panel">
          <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#flask-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90"><span class="nav-number">1.</span> <span class="nav-text">flask 源码解析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#WSGI"><span class="nav-number">1.1.</span> <span class="nav-text">WSGI</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BA%94%E7%94%A8%E7%9A%84%E5%88%9B%E5%BB%BA"><span class="nav-number">1.2.</span> <span class="nav-text">应用的创建</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BA%94%E7%94%A8%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B"><span class="nav-number">1.3.</span> <span class="nav-text">应用启动过程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E8%BF%87%E7%A8%8B"><span class="nav-number">1.4.</span> <span class="nav-text">请求处理过程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A7%86%E5%9B%BE%E5%87%BD%E6%95%B0%E6%B3%A8%E5%86%8C"><span class="nav-number">1.5.</span> <span class="nav-text">视图函数注册</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%B7%E6%B1%82%E4%B8%8A%E4%B8%8B%E6%96%87"><span class="nav-number">1.6.</span> <span class="nav-text">请求上下文</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">1.7.</span> <span class="nav-text">总结</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E4%B8%AA%E8%AF%B7%E6%B1%82%E7%9A%84%E6%97%85%E7%A8%8B"><span class="nav-number">1.7.1.</span> <span class="nav-text">一个请求的旅程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Flask-%E5%92%8C-werkzeug"><span class="nav-number">1.7.2.</span> <span class="nav-text">Flask 和 werkzeug</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E9%98%85%E8%AF%BB"><span class="nav-number">1.7.3.</span> <span class="nav-text">参考阅读</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%87%E7%AB%A0%E6%9B%B4%E6%96%B0%E8%AE%B0%E5%BD%95"><span class="nav-number">1.8.</span> <span class="nav-text">文章更新记录</span></a></li></ol></li></ol></div>
      </section>
      <!--/noindex-->

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="libaibuaidufu"
      src="/uploads/avatar.jpg">
  <p class="site-author-name" itemprop="name">libaibuaidufu</p>
  <div class="site-description" itemprop="description">李白不爱杜甫的日常</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">15</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/libaibuaidufu" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;libaibuaidufu" rel="noopener" target="_blank"><i class="github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:libaibuaidufu@gmail.com" title="E-Mail → mailto:libaibuaidufu@gmail.com" rel="noopener" target="_blank"><i class="envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </section>
    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </header>

      
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div id="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


      <div class="main-inner">
        

        <div class="content post posts-expand">
          

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://libaibuaidufu.club/post/%E8%BD%AC%E8%BD%BD-flask%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.jpg">
      <meta itemprop="name" content="libaibuaidufu">
      <meta itemprop="description" content="李白不爱杜甫的日常">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="libaibuaidufu">
    </span>

    
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          转载-flask源码分析
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-08-13 16:03:23 / 修改时间：16:03:55" itemprop="dateCreated datePublished" datetime="2020-08-13T16:03:23+08:00">2020-08-13</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%BD%AC%E8%BD%BD/" itemprop="url" rel="index"><span itemprop="name">转载</span></a>
                </span>
            </span>

          
            <span id="/post/%E8%BD%AC%E8%BD%BD-flask%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.html" class="post-meta-item leancloud_visitors" data-flag-title="转载-flask源码分析" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/post/%E8%BD%AC%E8%BD%BD-flask%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.html#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="post/转载-flask源码分析.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/post/%E8%BD%AC%E8%BD%BD-flask%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/post/%E8%BD%AC%E8%BD%BD-flask%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>15k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>13 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>本来想着写第二篇的，但是一直没有什么头绪，就把以前自己看过的文章转载一下，同时在温故而知新。然后在根据理解在进行写。我要转载也是因为别人写的好很详细。</p>
<p>同时还有更详细的 就是此作者在后面的参考中的。当然我也是看过的，别人写的更加详细。以模块分类进行深度讲解。</p>
<p>看了下面两篇可以让你对Flask有着更深的认识。</p>
<p>后续我也会写一些自己的认识。</p>
<a id="more"></a>

<p>转载：<a target="_blank" rel="noopener" href="https://juejin.im/post/6844903533238566925">flask 源码解析</a></p>
<p>文章系列：<a target="_blank" rel="noopener" href="https://cizixs.com/2017/01/10/flask-insight-introduction/">flask 源码解析：简介</a></p>
<h1 id="flask-源码解析"><a href="#flask-源码解析" class="headerlink" title="flask 源码解析"></a>flask 源码解析</h1><p>本文简单的分析了 Flask 的源码，主要关注 WSGI、Flask 对象的数据结构、Flask 应用启动过程、请求处理过程、视图函数、URL 的映射、应用上下文和请求上下文。讲解这些主题时也不会面面俱到，请按照你阅读源码的需要自行探索。要读懂本文，你需要较为熟悉 Flask，比如已经用 Flask 写过一个小项目，并且有一定的阅读代码的能力，并对 web 框架的功能有基本了解。</p>
<p>本文会不时更新，最近更新日期：2017年9月10日。</p>
<p>这是 Flask 官方钦定的 Demo 代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(‘/‘)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>():</span></span><br><span class="line">    <span class="keyword">return</span> ‘Hello, world!’</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == ‘__main__’:</span><br><span class="line">    app.run()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这篇文章从这个简单的代码开始，简要介绍了 WSGI、Flask 对象的数据结构、Flask 应用启动过程、请求处理过程、视图函数、URL 的映射、request 和 response 类（应用上下文和请求上下文），这些主题涵盖了一个 web 框架的核心。</p>
<h2 id="WSGI"><a href="#WSGI" class="headerlink" title="WSGI"></a>WSGI</h2><p>在用户发起的请求到达服务器之后，会被一个 HTTP 服务器所接收，然后交给 web 应用程序做业务处理，这样 HTTP 服务器和 web 应用之间就需要一个接口，在 Python web 开发的世界里，Python 官方<strong>钦定</strong>了这个接口并命名为 WSGI，由 PEP333 所规定。只要服务器和框架都遵守这个约定，那么就能实现服务器和框架的任意组合。按照这个规定，一个面向 WSGI 的框架必须要实现这个方法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">application</span>(<span class="params">environ, start_response</span>)</span></span><br></pre></td></tr></table></figure>

<p>在工作过程中，HTTP 服务器会调用上面这个方法，传入请求信息，即名为 <code>environ</code> 的字典和 <code>start_response</code> 函数，应用从 <code>environ</code> 中获取请求信息，在进行业务处理后调用 <code>start_response</code> 设置响应头，并返回响应体（必须是一个可遍历的对象，比如列表、字典）给 HTTP 服务器，HTTP 服务器再返回响应给用户。</p>
<p>所以 Flask 作为一个开发 web 应用的 web 框架，负责解决的问题就是：</p>
<ol>
<li>作为一个应用，能够被 HTTP 服务器所调用，必须要有 <code>__call__</code> 方法</li>
<li>通过传入的请求信息（URL、HTTP 方法等），找到正确的业务处理逻辑，即正确的视图函数</li>
<li>处理业务逻辑，这些逻辑可能包括表单检查、数据库 CRUD 等（这个在这篇文章里不会涉及）</li>
<li>返回正确的响应</li>
<li>在同时处理多个请求时，还需要保护这些请求，知道应该用哪个响应去匹配哪个请求，即线程保护</li>
</ol>
<p>下面就来看看 Flask 是如何解决这些问题的。</p>
<blockquote>
<p>参考阅读：<a target="_blank" rel="noopener" href="http://python.jobbole.com/81524/">一起写一个 web 服务器</a>，该系列文章能够让你基本理解 web 服务器和框架是如何通过 WSGI 协同工作的。</p>
</blockquote>
<h2 id="应用的创建"><a href="#应用的创建" class="headerlink" title="应用的创建"></a>应用的创建</h2><blockquote>
<p>源码阅读：<code>app.py</code> 中 <code>Flask</code> 类的代码。</p>
</blockquote>
<p>Demo 代码的第二行创建了一个 Flask 类的实例，传入的参数是当前模块的名字。我们先来看看 Flask 应用到底是什么，它的数据结构是怎样的。</p>
<p><code>Flask</code> 是这样一个类：</p>
<blockquote>
<p>The flask object implements a WSGI application and acts as the central object. It is passed the name of the module or package of the application. Once it is created it will act as a central registry for the view functions, the URL rules, template configuration and much more.</p>
</blockquote>
<blockquote>
<p>The name of the package is used to resolve resources from inside the package or the folder the module is contained in depending on if the package parameter resolves to an actual python package (a folder with an <code>__init__.py</code> file inside) or a standard module (just a <code>.py</code> file).</p>
</blockquote>
<blockquote>
<p>一个 Flask 对象实际上是一个 WSGI 应用。它接收一个模块或包的名字作为参数。它被创建之后，所有的视图函数、URL 规则、模板设置等都会被注册到它上面。之所以要传入模块或包的名字，是为了定位一些资源。</p>
</blockquote>
<p>Flask 类有这样一些属性：</p>
<ul>
<li><code>request_class = Request</code> 设置请求的类型</li>
<li><code>response_class = Response</code> 设置响应的类型</li>
</ul>
<p>这两个类型都来源于它的依赖库 <code>werkzeug</code> 并做了简单的拓展。</p>
<p>Flask 对象的 <code>__init__</code> 方法如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, package_name</span>):</span></span><br><span class="line">    <span class="comment">#: Flask 对象有这样一个字典来保存所有的视图函数</span></span><br><span class="line">    self.view_functions = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#: 这个字典用来保存所有的错误处理视图函数</span></span><br><span class="line">    <span class="comment">#: 字典的 key 是错误类型码</span></span><br><span class="line">    self.error_handlers = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#: 这个列表用来保存在请求被分派之前应当执行的函数</span></span><br><span class="line">    self.before_request_funcs = []</span><br><span class="line"></span><br><span class="line">    <span class="comment">#: 在接收到第一个请求的时候应当执行的函数</span></span><br><span class="line">    self.before_first_request_funcs = []</span><br><span class="line"></span><br><span class="line">    <span class="comment">#: 这个列表中的函数在请求完成之后被调用，响应对象会被传给这些函数</span></span><br><span class="line">    self.after_request_funcs = []</span><br><span class="line"></span><br><span class="line">    <span class="comment">#: 这里设置了一个 url_map 属性，并把它设置为一个 Map 对象</span></span><br><span class="line">    self.url_map = Map()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>到这里一个 Flask 对象创建完毕并被变量 <code>app</code> 所指向，其实它就是一个保存了一些配置信息，绑定了一些视图函数并且有个 URL 映射对象（<code>url_map</code>）的对象。但我们还不知道这个 Map 对象是什么，有什么作用，从名字上看，似乎其作用是映射 URL 到视图函数。源代码第 21 行有 <code>from werkzeug.routing import Map, Rule</code>，那我们就来看看 <code>werkzeug</code> 这个库中对 Map 的定义：</p>
<blockquote>
<p>The map class stores all the URL rules and some configuration parameters. Some of the configuration values are only stored on the <code>Map</code> instance since those affect all rules, others are just defaults and can be overridden for each rule. Note that you have to specify all arguments besides the <code>rules</code> as keyword arguments!</p>
</blockquote>
<p>可以看到这个类的对象储存了所有的 URL 规则和一些配置信息。由于 <code>werkzeug</code> 的映射机制比较复杂，我们下文中讲到映射机制的时候再深入了解，现在只要记住 Flask 应用（即一个 <code>Flask</code> 类的实例）存储了视图函数，并通过 <code>url_map</code> 这个变量存储了一个 URL 映射机构就可以了。</p>
<h2 id="应用启动过程"><a href="#应用启动过程" class="headerlink" title="应用启动过程"></a>应用启动过程</h2><blockquote>
<p>源码阅读：<code>app.py</code> 中 <code>Flask</code> 类的代码和 <code>werkzeug.serving</code> 的代码，特别注意 <code>run_simple</code> <code>BaseWSGIServer</code> <code>WSGIRequestHandler</code>。</p>
</blockquote>
<p>Demo 代码的第 6 行是一个限制，表示如果 Python 解释器是直接运行该文件或包的，则运行 Flask 程序：在 Python 中，如果直接执行一个模块或包，那么解释器就会把当前模块或包的 <code>__name__</code> 设置为为 <code>__main_</code>。</p>
<p>第 7 行中的 <code>run</code> 方法启动了 Flask 应用：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self, host=None, port=None, debug=None, **options</span>):</span></span><br><span class="line">    <span class="keyword">from</span> werkzeug.serving <span class="keyword">import</span> run_simple</span><br><span class="line">    <span class="keyword">if</span> host <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        host = <span class="string">&#x27;127.0.0.1&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> port <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        server_name = self.config[<span class="string">&#x27;SERVER_NAME&#x27;</span>]</span><br><span class="line">        <span class="keyword">if</span> server_name <span class="keyword">and</span> <span class="string">&#x27;:&#x27;</span> <span class="keyword">in</span> server_name:</span><br><span class="line">            port = int(server_name.rsplit(<span class="string">&#x27;:&#x27;</span>, <span class="number">1</span>)[<span class="number">1</span>])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            port = <span class="number">5000</span></span><br><span class="line">    <span class="keyword">if</span> debug <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        self.debug = bool(debug)</span><br><span class="line">    options.setdefault(<span class="string">&#x27;use_reloader&#x27;</span>, self.debug)</span><br><span class="line">    options.setdefault(<span class="string">&#x27;use_debugger&#x27;</span>, self.debug)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        run_simple(host, port, self, **options)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="comment"># reset the first request information if the development server</span></span><br><span class="line">        <span class="comment"># reset normally.  This makes it possible to restart the server</span></span><br><span class="line">        <span class="comment"># without reloader and that stuff from an interactive shell.</span></span><br><span class="line">        self._got_first_request = <span class="literal">False</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以看到这个方法基本上是在配置参数，实际上启动服务器的是 <code>werkzeug</code> 的 <code>run_simple</code> 方法，该方法在默认情况下启动了服务器 <code>BaseWSGIServer</code>，继承自 Python 标准库中的 <code>HTTPServer.TCPServer</code>。注意在调用 <code>run_simple</code> 时，Flask 对象把自己 <code>self</code> 作为参数传进去了，这是正确的，因为服务器在收到请求的时候，必须要知道应该去调用谁的 <code>__call__</code> 方法。</p>
<p>按照标准库中 <code>HTTPServer.TCPServer</code> 的模式，服务器必须有一个类来作为 request handler 来处理收到的请求，而不是由 <code>HTTPServer.TCPServer</code> 本身的实例来处理，<code>werkzeug</code> 提供了 <code>WSGIRequestHandler</code> 类来作为 request handler，这个类在被 <code>BaseWSGIServer</code> 调用时，会执行这个函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">execute</span>(<span class="params">app</span>):</span></span><br><span class="line">    application_iter = app(environ, start_response)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">for</span> data <span class="keyword">in</span> application_iter:</span><br><span class="line">            write(data)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> headers_sent:</span><br><span class="line">            write(<span class="string">b&#x27;&#x27;</span>)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="keyword">if</span> hasattr(application_iter, <span class="string">&#x27;close&#x27;</span>):</span><br><span class="line">            application_iter.close()</span><br><span class="line">        application_iter = <span class="literal">None</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>函数的第一行就是按照 WSGI 要求的，调用了 app 并把 <code>environ</code> 和 <code>start_response</code> 传入。我们再看看 flask 中是如何按照 WSGI 要求对服务器的调用进行呼应的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__call__</span>(<span class="params">self, environ, start_response</span>):</span></span><br><span class="line">    <span class="keyword">return</span> self.wsgi_app(environ, start_response)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">wsgi_app</span>(<span class="params">self, environ, start_response</span>):</span></span><br><span class="line">    ctx = self.request_context(environ)</span><br><span class="line">    ctx.push()</span><br><span class="line">    error = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            response = self.full_dispatch_request()</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            error = e</span><br><span class="line">            response = self.handle_exception(e)</span><br><span class="line">        <span class="keyword">return</span> response(environ, start_response)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="keyword">if</span> self.should_ignore_error(error):</span><br><span class="line">            error = <span class="literal">None</span></span><br><span class="line">        ctx.auto_pop(error)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以看到 Flask 按照 WSGI 的要求实现了 <code>__call__</code> 方法，因此成为了一个可调用的对象。但它不是在直接在 <code>__call__</code> 里写逻辑的，而是调用了 <code>wsgi_app</code> 方法，这是为了中间件的考虑，不展开谈了。这个方法返回的 <code>response(environ, start_response)</code> 中，<code>response</code> 是 <code>werkzueg.response</code> 类的一个实例，它也是个可以调用的对象，这个对象会负责生成最终的可遍历的响应体，并调用 <code>start_response</code> 形成响应头。</p>
<h2 id="请求处理过程"><a href="#请求处理过程" class="headerlink" title="请求处理过程"></a>请求处理过程</h2><blockquote>
<p>源码阅读：<code>app.Flask</code> 的代码。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">wsgi_app</span>(<span class="params">self, environ, start_response</span>):</span></span><br><span class="line">    ctx = self.request_context(environ)</span><br><span class="line">    ctx.push()</span><br><span class="line">    error = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            response = self.full_dispatch_request()</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            error = e</span><br><span class="line">            response = self.handle_exception(e)</span><br><span class="line">        <span class="keyword">return</span> response(environ, start_response)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="keyword">if</span> self.should_ignore_error(error):</span><br><span class="line">            error = <span class="literal">None</span></span><br><span class="line">        ctx.auto_pop(error)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>wsgi_app</code> 方法中里面的内容就是对请求处理过程的一个高度抽象。</p>
<p>首先，在接收到服务器传过来的请求时，Flask 调用 <code>request_context</code> 函数建立了一个 <code>RequestContext</code> 请求上下文对象，并把它压入 <code>_request_ctx_stack</code> 栈。关于上下文和栈的内容下文会再讲到，你现在需要知道的是，这些操作是为了 flask 在处理多个请求的时候不会混淆。之后，Flask 会调用 <code>full_dispatch_request</code> 方法对这个请求进行分发，开始实际的请求处理过程，这个过程中会生成一个响应对象并最终通过调用 <code>response</code> 对象来返回给服务器。如果当中出错，就声称相应的错误信息。不管是否出错，最终 Flask 都会把请求上下文推出栈。</p>
<p><code>full_dispatch_request</code> 是请求分发的入口，我们再来看它的实现：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">full_dispatch_request</span>(<span class="params">self</span>):</span></span><br><span class="line">    self.try_trigger_before_first_request_functions()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        rv = self.preprocess_request()</span><br><span class="line">        <span class="keyword">if</span> rv <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            rv = self.dispatch_request()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        rv = self.handle_user_exception(e)</span><br><span class="line">    <span class="keyword">return</span> self.finalize_request(rv)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>首先调用 <code>try_trigger_before_first_request_functions</code> 方法来尝试调用 <code>before_first_request</code> 列表中的函数，如果 <code>Flask</code> 的 <code>_got_first_request</code> 属性为 <code>False</code>，<code>before_first_request</code> 中的函数就会被执行，执行一次之后，<code>_got_first_request</code> 就会被设置为 <code>True</code> 从而不再执行这些函数。</p>
<p>然后调用 <code>preprocess_request</code> 方法，这个方法调用 <code>before_request_funcs</code> 列表中所有的方法，如果这些 <code>before_request_funcs</code> 方法中返回了某种东西，那么就不会真的去分发这个请求。比如说，一个 <code>before_request_funcs</code> 方法是用来检测用户是否登录的，如果用户没有登录，那么这个方法就会调用 <code>abort</code> 方法从而返回一个错误，Flask 就不会分发这个请求而是直接报 401 错误。</p>
<p>如果 <code>before_request_funcs</code> 中的函数没有返回，那么再调用 <code>dispatch_request</code> 方法进行请求分发。这个方法首先会查看 URL 规则中有没有相应的 <code>endpoint</code> 和 <code>value</code> 值，如果有，那么就调用 <code>view_functions</code> 中相应的视图函数（<code>endpoint</code> 作为键值）并把参数值传入（<code>**req.view_args</code>），如果没有就由 <code>raise_routing_exception</code> 进行处理。视图函数的返回值或者错误处理视图函数的返回值会返回给 <code>wsgi_app</code> 方法中的 <code>rv</code> 变量。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dispatch_request</span>(<span class="params">self</span>):</span></span><br><span class="line">        req = _request_ctx_stack.top.request</span><br><span class="line">        <span class="keyword">if</span> req.routing_exception <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            self.raise_routing_exception(req)</span><br><span class="line">        rule = req.url_rule</span><br><span class="line">        <span class="keyword">if</span> getattr(rule, <span class="string">&#x27;provide_automatic_options&#x27;</span>, <span class="literal">False</span>) \</span><br><span class="line">           <span class="keyword">and</span> req.method == <span class="string">&#x27;OPTIONS&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> self.make_default_options_response()</span><br><span class="line">        <span class="keyword">return</span> self.view_functions[rule.endpoint](**req.view_args)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">finalize_request</span>(<span class="params">self, rv, from_error_handler=False</span>):</span></span><br><span class="line">    response = self.make_response(rv)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        response = self.process_response(response)</span><br><span class="line">        request_finished.send(self, response=response)</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> from_error_handler:</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">        self.logger.exception(<span class="string">&#x27;Request finalizing failed with an &#x27;</span></span><br><span class="line">                              <span class="string">&#x27;error while handling an error&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_response</span>(<span class="params">self, rv</span>):</span></span><br><span class="line">    <span class="keyword">if</span> isinstance(rv, self.response_class):</span><br><span class="line">        <span class="keyword">return</span> rv</span><br><span class="line">    <span class="keyword">if</span> isinstance(rv, basestring):</span><br><span class="line">        <span class="keyword">return</span> self.response_class(rv)</span><br><span class="line">    <span class="keyword">if</span> isinstance(rv, tuple):</span><br><span class="line">        <span class="keyword">return</span> self.response_class(*rv)</span><br><span class="line">    <span class="keyword">return</span> self.response_class.force_type(rv, request.environ)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后 Flask 就会根据 <code>rv</code> 生成响应，这个 <code>make_response</code> 方法会查看 rv 是否是要求的返回值类型，否则生成正确的返回类型。比如 Demo 中返回值是字符串，就会满足 <code>isinstance(rv, basestring)</code> 判断并从字符串生成响应。这一步完成之后，Flask 查看是否有后处理视图函数需要执行（在 <code>process_response</code> 方法中），并最终返回一个完全处理好的 <code>response</code> 对象。</p>
<h2 id="视图函数注册"><a href="#视图函数注册" class="headerlink" title="视图函数注册"></a>视图函数注册</h2><p>在请求处理过程一节中，我们已经看到了 Flask 是如何调用试图函数的，这一节我们要关注 Flask 如何构建和请求分派相关的数据结构。我们将主要关注 <code>view_functions</code>，因为其他的数据结构如 <code>before_request_funcs</code> 的构建过程大同小异，甚至更为简单。我们也将仔细讲解在应用的创建一节中遗留的问题，即 <code>url_map</code> 到底是什么。</p>
<p>Demo 代码的第 4 行用修饰器 <code>route</code> 注册一个视图函数，这是 Flask 中受到广泛称赞的一个设计。在 Flask 类的 <code>route</code> 方法中，可以看到它调用了 <code>add_url_rule</code> 方法。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">route</span>(<span class="params">self, rule, **options</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decorator</span>(<span class="params">f</span>):</span></span><br><span class="line">        endpoint = options.pop(<span class="string">&#x27;endpoint&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line">        self.add_url_rule(rule, endpoint, f, **options)</span><br><span class="line">        <span class="keyword">return</span> f</span><br><span class="line">    <span class="keyword">return</span> decorator</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_url_rule</span>(<span class="params">self, rule, endpoint, **options</span>):</span></span><br><span class="line">    <span class="keyword">if</span> endpoint <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        endpoint = _endpoint_from_view_func(view_func)</span><br><span class="line">    options[<span class="string">&#x27;endpoint&#x27;</span>] = endpoint</span><br><span class="line">    methods = options.pop(<span class="string">&#x27;methods&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line">    <span class="keyword">if</span> methods <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        methods = getattr(view_func, <span class="string">&#x27;methods&#x27;</span>, <span class="literal">None</span>) <span class="keyword">or</span> (<span class="string">&#x27;GET&#x27;</span>,)</span><br><span class="line">    <span class="keyword">if</span> isinstance(methods, string_types):</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">&#x27;Allowed methods have to be iterables of strings, &#x27;</span></span><br><span class="line">                        <span class="string">&#x27;for example: @app.route(..., methods=[&quot;POST&quot;])&#x27;</span>)</span><br><span class="line">    methods = set(item.upper() <span class="keyword">for</span> item <span class="keyword">in</span> methods)</span><br><span class="line"></span><br><span class="line">    required_methods = set(getattr(view_func, <span class="string">&#x27;required_methods&#x27;</span>, ()))</span><br><span class="line"></span><br><span class="line">    provide_automatic_options = getattr(view_func,</span><br><span class="line">        <span class="string">&#x27;provide_automatic_options&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> provide_automatic_options <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;OPTIONS&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> methods:</span><br><span class="line">            provide_automatic_options = <span class="literal">True</span></span><br><span class="line">            required_methods.add(<span class="string">&#x27;OPTIONS&#x27;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            provide_automatic_options = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    methods |= required_methods</span><br><span class="line"></span><br><span class="line">    rule = self.url_rule_class(rule, methods=methods, **options)</span><br><span class="line">    rule.provide_automatic_options = provide_automatic_options</span><br><span class="line"></span><br><span class="line">    self.url_map.add(rule)</span><br><span class="line">    <span class="keyword">if</span> view_func <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        old_func = self.view_functions.get(endpoint)</span><br><span class="line">        <span class="keyword">if</span> old_func <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> old_func != view_func:</span><br><span class="line">            <span class="keyword">raise</span> AssertionError(<span class="string">&#x27;View function mapping is overwriting an &#x27;</span></span><br><span class="line">                                 <span class="string">&#x27;existing endpoint function: %s&#x27;</span> % endpoint)</span><br><span class="line">        self.view_functions[endpoint] = view_func</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这个方法负责注册视图函数，并实现 URL 到视图函数的映射。首先，它要准备好一个视图函数所支持的 HTTP 方法（基本上一半多的代码都是在做这个），然后通过 <code>url_rule_class</code> 创建一个 <code>rule</code> 对象，并把这个对象添加到自己的 <code>url_map</code> 里。我们那个遗留问题在这里就得到解答了：<code>rule</code> 对象是一个保存合法的（Flask 应用所支持的） URL、方法、<code>endpoint</code>（在 <code>**options</code> 中） 及它们的对应关系的数据结构，而 <code>url_map</code> 是保存这些对象的集合。然后，这个方法将视图函数添加到 <code>view_functions</code> 当中，<code>endpoint</code> 作为它的键，其值默认是函数名。</p>
<p>我们再来深入了解一下 <code>rule</code> ，它被定义在 <code>werkzeug.routing.Rule</code> 中：</p>
<blockquote>
<p>A Rule represents one URL pattern. There are some options for <code>Rule</code> that change the way it behaves and are passed to the <code>Rule</code> constructor. 一个 Rule 对象代表了一种 URL 模式，可以通过传入参数来改变它的许多行为。</p>
</blockquote>
<p>Rule 的 <code>__init__</code> 方法为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, string, defaults=None, subdomain=None, methods=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                 build_only=False, endpoint=None, strict_slashes=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                 redirect_to=None, alias=False, host=None</span>):</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> string.startswith(<span class="string">&#x27;/&#x27;</span>):</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">&#x27;urls must start with a leading slash&#x27;</span>)</span><br><span class="line">    self.rule = string</span><br><span class="line">    self.is_leaf = <span class="keyword">not</span> string.endswith(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    self.map = <span class="literal">None</span></span><br><span class="line">    self.strict_slashes = strict_slashes</span><br><span class="line">    self.subdomain = subdomain</span><br><span class="line">    self.host = host</span><br><span class="line">    self.defaults = defaults</span><br><span class="line">    self.build_only = build_only</span><br><span class="line">    self.alias = alias</span><br><span class="line">    <span class="keyword">if</span> methods <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        self.methods = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">if</span> isinstance(methods, str):</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">&#x27;param `methods` should be `Iterable[str]`, not `str`&#x27;</span>)</span><br><span class="line">        self.methods = set([x.upper() <span class="keyword">for</span> x <span class="keyword">in</span> methods])</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;HEAD&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> self.methods <span class="keyword">and</span> <span class="string">&#x27;GET&#x27;</span> <span class="keyword">in</span> self.methods:</span><br><span class="line">            self.methods.add(<span class="string">&#x27;HEAD&#x27;</span>)</span><br><span class="line">    self.endpoint = endpoint</span><br><span class="line">    self.redirect_to = redirect_to</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> defaults:</span><br><span class="line">        self.arguments = set(map(str, defaults))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        self.arguments = set()</span><br><span class="line">    self._trace = self._converters = self._regex = self._weights = <span class="literal">None</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>一个 Rule 被创建后，通过 <code>Map</code> 的 <code>add</code> 方法被绑定到 <code>Map</code> 对象上，我们之前说过 <code>flask.url_map</code> 就是一个 <code>Map</code> 对象。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">self, rulefactory</span>):</span></span><br><span class="line">    <span class="keyword">for</span> rule <span class="keyword">in</span> rulefactory.get_rules(self):</span><br><span class="line">        rule.bind(self)</span><br><span class="line">        self._rules.append(rule)</span><br><span class="line">        self._rules_by_endpoint.setdefault(rule.endpoint, []).append(rule)</span><br><span class="line">    self._remap = <span class="literal">True</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>而 <code>Rule</code> 的 <code>bind</code> 方法的内容，就是添加 <code>Rule</code> 对应的 <code>Map</code>，然后调用 <code>compile</code> 方法生成一个正则表达式，<code>compile</code> 方法比较复杂，就不展开了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bind</span>(<span class="params">self, map, rebind=False</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Bind the url to a map and create a regular expression based on</span></span><br><span class="line"><span class="string">    the information from the rule itself and the defaults from the map.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :internal:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> self.map <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> <span class="keyword">not</span> rebind:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">&#x27;url rule %r already bound to map %r&#x27;</span> %</span><br><span class="line">                           (self, self.map))</span><br><span class="line">    self.map = map</span><br><span class="line">    <span class="keyword">if</span> self.strict_slashes <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        self.strict_slashes = map.strict_slashes</span><br><span class="line">    <span class="keyword">if</span> self.subdomain <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        self.subdomain = map.default_subdomain</span><br><span class="line">    self.compile()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在 Flask 应用收到请求时，这些被绑定到 <code>url_map</code> 上的 <code>Rule</code> 会被查看，来找到它们对应的视图函数。这是在请求上下文中实现的，我们先前在 <code>dispatch_request</code> 方法中就见过——我们是从 <code>_request_ctx_stack.top.request</code> 得到 <code>rule</code> 并从这个 <code>rule</code> 找到 <code>endpoint</code>，最终找到用来处理该请求的正确的视图函数的。所以，接下来我们需要看请求上下的具体实现，并且看一看 Flask 是如何从 <code>url_map</code> 中找到这个 <code>rule</code> 的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dispatch_request</span>(<span class="params">self</span>):</span></span><br><span class="line">    req = _request_ctx_stack.top.request</span><br><span class="line">    <span class="keyword">if</span> req.routing_exception <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        self.raise_routing_exception(req)</span><br><span class="line">    rule = req.url_rule</span><br><span class="line">    <span class="keyword">if</span> getattr(rule, <span class="string">&#x27;provide_automatic_options&#x27;</span>, <span class="literal">False</span>) \</span><br><span class="line">       <span class="keyword">and</span> req.method == <span class="string">&#x27;OPTIONS&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> self.make_default_options_response()</span><br><span class="line">    <span class="keyword">return</span> self.view_functions[rule.endpoint](**req.view_args)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="请求上下文"><a href="#请求上下文" class="headerlink" title="请求上下文"></a>请求上下文</h2><blockquote>
<p>源码阅读：<code>ctx.RequestContext</code> 的代码。</p>
</blockquote>
<p>请求上下文是如何、在何时被创建的呢？我们先前也见过，在服务器调用应用的时候，Flask 的 <code>wsgi_app</code> 中有这样的语句，就是创建了请求上下文并压栈。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">wsgi_app</span>(<span class="params">self, environ, start_response</span>):</span></span><br><span class="line">    ctx = self.request_context(environ)</span><br><span class="line">    ctx.push()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>request_context</code> 方法非常简单，就是创建了 <code>RequestContext</code> 类的一个实例，这个类被定义在 <code>flask.ctx</code> 文件中，它包含了一系列关于请求的信息，<strong>最重要的是</strong>它自身的 <code>request</code> 属性指向了一个 <code>Request</code> 类的实例，这个类继承自 <code>werkzeug.Request</code>，在 <code>RequestContext</code> 的创建过程中，它会根据传入的 <code>environ</code> 创建一个 <code>werkzeug.Request</code> 的实例。</p>
<p>接着 <code>RequestContext</code> 的 <code>push</code> 方法被调用，这个方法将自己推到 <code>_request_ctx_stack</code> 的栈顶。</p>
<p><code>_request_ctx_stack</code> 被定义在 <code>flask.global</code> 文件中，它是一个 <code>LocalStack</code> 类的实例，是 <code>werkzeug.local</code> 所实现的，如果你对 Python 的 threading 熟悉的话，就会发现这里实现了线程隔离，就是说，在 Python 解释器运行到 <code>_request_ctx_stack</code> 相关代码的时候，解释器会根据当前进程来选择正确的实例。</p>
<p>但是，在整个分析 Flask 源码的过程中，我们也没发现 Flask 在被调用之后创建过线程啊，那么为什么要做线程隔离呢？看我们开头提到的 <code>run</code> 函数，其实它可以传一个 <code>threaded</code> 参数。当不传这个函数的时候，我们启动的是 <code>BasicWSGIServer</code>，这个服务器是单线程单进程的，Flask 的线程安全自然没有意义，但是当我们传入这个参数的时候，我们启动的是 <code>ThreadedWSGIServer</code>，这时 Flask 的线程安全就是有意义的了，在其他多线程的服务器中也是一样。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><h3 id="一个请求的旅程"><a href="#一个请求的旅程" class="headerlink" title="一个请求的旅程"></a>一个请求的旅程</h3><p>这里，我们通过追踪一个请求到达服务器并返回（当然是通过“变成”一个相应）的旅程，串讲本文的内容。</p>
<ol>
<li>在请求发出之前，Flask 注册好了所有的视图函数和 URL 映射，服务器在自己身上注册了 Flask 应用。</li>
<li>请求到达服务器，服务器准备好 <code>environ</code> 和 <code>make_response</code> 函数，然后调用了自己身上注册的 Flask 应用。</li>
<li>应用实现了 WSGI 要求的 <code>application(environ, make_response)</code> 方法。在 Flask 中，这个方法是个被 <code>__call__</code> 中转的叫做 <code>wsgi_app</code> 的方法。它首先通过 <code>environ</code> 创建了请求上下文，并将它推入栈，使得 flask 在处理当前请求的过程中都可以访问到这个请求上下文。</li>
<li>然后 Flask 开始处理这个请求，依次调用 <code>before_first_request_funcs</code> <code>before_request_funcs</code> <code>view_functions</code> 中的函数，并最终通过 <code>finalize_request</code> 生成一个 <code>response</code> 对象，当中只要有函数返回值，后面的函数组就不会再执行，<code>after_request_funcs</code> 进行 <code>response</code> 生成后的后处理。</li>
<li>Flask 调用这个 <code>response</code> 对象，最终调用了 <code>make_response</code> 函数，并返回了一个可遍历的响应内容。</li>
<li>服务器发送响应。</li>
</ol>
<h3 id="Flask-和-werkzeug"><a href="#Flask-和-werkzeug" class="headerlink" title="Flask 和 werkzeug"></a>Flask 和 werkzeug</h3><p>在分析过程中，可以很明显地看出 Flask 和 <code>werkzeug</code> 是强耦合的，实际上 <code>werkzeug</code> 是 Flask 唯一不可或缺的依赖，一些非常细节的工作，其实都是 <code>werkzeug</code> 库完成的，在本文的例子中，它至少做了这些事情：</p>
<ol>
<li>封装 <code>Response</code> 和 <code>Request</code> 类型供 Flask 使用，在实际开发中，我们在请求和响应对象上的操作，调用的其实是 <code>werkzeug</code> 的方法。</li>
<li>实现 URL 到视图函数的映射，并且能把 URL 中的参数传给该视图函数。我们看到了 Flask 的 url_map 属性并且看到了它如何绑定视图函数和错误处理函数，但是具体的映射规则的实践，和在响应过程中的 URL 解析，都是由 werkzeug 完成的。</li>
<li>通过 LocalProxy 类生成的 <code>_request_ctx_stack</code> 对 Flask 实现线程保护。</li>
</ol>
<p>对于 Flask 的源码分析先暂时到这里。有时间的话，我会分析 Flask 中的模板渲染、<code>import request</code>、蓝图和一些好用的变量及函数，或者深入分析 <code>werkzeug</code> 库。</p>
<h3 id="参考阅读"><a href="#参考阅读" class="headerlink" title="参考阅读"></a>参考阅读</h3><ol>
<li><a target="_blank" rel="noopener" href="http://cizixs.com/2017/01/10/flask-insight-introduction">flask 源码解析系列文章</a>，你可以在读完本文了解主线之后，再看这系列文章了解更加细节的东西。</li>
<li><a target="_blank" rel="noopener" href="http://python.jobbole.com/81524/">一起写一个 web 服务器</a>。</li>
</ol>
<h2 id="文章更新记录"><a href="#文章更新记录" class="headerlink" title="文章更新记录"></a>文章更新记录</h2><ul>
<li>2017年9月10日：利用 0.12.0 版本进行分析，重新调整了结构和行文顺序，增加了许多内容。</li>
</ul>

    </div>

    
    
    
        

  <div class="followme">
    <p>欢迎关注我的其它发布渠道</p>

    <div class="social-list">

        <div class="social-item">
          <a target="_blank" class="social-link" href="/uploads/wechat-qcode.jpg">
            <span class="icon">
              <i class="fab fa-weixin"></i>
            </span>

            <span class="label">WeChat</span>
          </a>
        </div>
    </div>
  </div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/flask/" rel="tag"># flask</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/post/flask%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E4%B8%80.html" rel="prev" title="flask源码分析(一)">
      <i class="fa fa-chevron-left"></i> flask源码分析(一)
    </a></div>
      <div class="post-nav-item">
    <a href="/post/wsl-%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1-crontab%E6%9D%83%E9%99%90.html" rel="next" title="wsl 定时任务 crontab权限">
      wsl 定时任务 crontab权限 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



        </div>
        
      <div class="tabs tabs-comment">
        <ul class="nav-tabs">
            <li class="tab"><a href="#comment-valine">valine</a></li>
            <li class="tab"><a href="#comment-disqus">disqus</a></li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane valine" id="comment-valine">
              <div class="comments" id="valine-comments"></div>
            </div>
            <div class="tab-pane disqus" id="comment-disqus">
              
  <div class="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  
            </div>
        </div>
      </div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">libaibuaidufu</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">48k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">44 分钟</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/next-theme/pjax@0/pjax.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>

  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '.page-configurations',
    '.main-inner',
    '.post-toc-wrap',
    '.languages',
    '.pjax'
  ],
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

document.addEventListener('pjax:success', () => {
  pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  const hasTOC = document.querySelector('.post-toc');
  document.querySelector('.sidebar-inner').classList.toggle('sidebar-nav-active', hasTOC);
  document.querySelector(hasTOC ? '.sidebar-nav-toc' : '.sidebar-nav-overview').click();
  NexT.utils.updateSidebarPosition();
});
</script>


  




  
<script src="/js/local-search.js"></script>













    <div class="pjax">
  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://libaibuaidufu.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>
<script>
  var disqus_config = function() {
    this.page.url = "https://libaibuaidufu.club/post/%E8%BD%AC%E8%BD%BD-flask%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.html";
    this.page.identifier = "post/转载-flask源码分析.html";
    this.page.title = "转载-flask源码分析";
    };
  NexT.utils.loadComments('#disqus_thread', () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: disqus_config
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://libaibuaidufu.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });
</script>


<script>
NexT.utils.loadComments('#valine-comments', () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/valine@1/dist/Valine.min.js', () => {
    new Valine(Object.assign({
      el  : '#valine-comments',
      path: location.pathname,
    }, {"enable":true,"appId":"gCNyW4RIETLbBYbENmjSSC8M-gzGzoHsz","appKey":"ECydfnAcQ3LpBHvVtKHLU6lw","placeholder":"欢迎畅所欲言","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"language":"zh-cn","visitor":true,"comment_count":true,"recordIP":false,"serverURLs":null,"enableQQ":false,"requiredFields":[]}
    ));
  }, window.Valine);
});
</script>

    </div>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"react":{"opacity":0.7},"log":false});</script></body>
</html>
